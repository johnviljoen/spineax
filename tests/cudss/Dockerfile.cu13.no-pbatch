FROM nvidia/cuda:13.0.0-devel-ubuntu24.04

RUN apt-get update && apt-get install -y \
    python3.12 python3.12-dev python3.12-venv python3-pip git \
    cmake ninja-build \
    && rm -rf /var/lib/apt/lists/*

# Create and activate virtual environment (uses site-packages, not dist-packages)
RUN python3.12 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

WORKDIR /workspace
COPY . .

# Install build + CUDA dependencies first (needed at build time)
RUN pip install --upgrade pip && \
    pip install "scikit-build-core>=0.5" nanobind "jax[cuda13]>=0.8.0" nvidia-cudss-cu13 pytest && \
    pip install --no-build-isolation --config-settings=cmake.args="-DBUILD_PBATCH_SOLVE=OFF" .[cuda13]

CMD ["bash"]
